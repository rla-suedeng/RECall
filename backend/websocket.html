<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ğŸ¤ Voice Chat with GPT + TTS</title>
</head>
<body>
  <h2>ğŸ—£ï¸ Voice â†’ STT â†’ GPT â†’ TTS</h2>

  <label>Firebase Token:</label><br>
  <input id="token" placeholder="Bearer ..." size="80" /><br><br>

  <button onclick="startRecording()">ğŸ™ï¸ Start Recording</button>
  <button onclick="stopRecording()">â¹ï¸ Stop</button>

  <h3>ğŸ§  GPT ì‘ë‹µ:</h3>
  <div id="response" style="white-space: pre-wrap; border: 1px solid #ccc; padding: 10px;"></div>

  <script>
    let socket;
    let mediaRecorder;
    let audioChunks = [];
    let eventStream;

    function appendText(text) {
      const div = document.getElementById("response");
      div.innerText += text;
    }

    async function startRecording() {

      // 1. WebSocket ì—°ê²°
      const token = document.getElementById("token").value;
      const socket = new WebSocket("ws://localhost:8000/voice-chat?token=" + encodeURIComponent(token));


      socket.onopen = () => {
        console.log("âœ… WebSocket ì—°ê²°ë¨");
      };

      socket.onmessage = (event) => {
        if (event.data.startsWith("event: audio")) {
          // ë‹¤ìŒ ì¤„ì´ data
          const b64 = event.data.split("\n")[1].replace("data: ", "").trim();
          const audio = new Audio("data:audio/mp3;base64," + b64);
          audio.play();
        } else {
          appendText(event.data);
        }
      };

      socket.onerror = () => {
        console.error("âŒ WebSocket ì—ëŸ¬");
      };

      // 2. ë§ˆì´í¬ ë…¹ìŒ
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      mediaRecorder = new MediaRecorder(stream);
      audioChunks = [];

      mediaRecorder.ondataavailable = (e) => {
        if (e.data.size > 0) audioChunks.push(e.data);
      };

      mediaRecorder.onstop = async () => {
        const audioBlob = new Blob(audioChunks, { type: "audio/mp3" });
        const buffer = await audioBlob.arrayBuffer();
        socket.send(buffer);
      };

      mediaRecorder.start();
      console.log("ğŸ™ï¸ ë…¹ìŒ ì‹œì‘");
    }

    function stopRecording() {
      if (mediaRecorder && mediaRecorder.state !== "inactive") {
        mediaRecorder.stop();
        console.log("â¹ï¸ ë…¹ìŒ ì¤‘ì§€");
      }
    }
  </script>
</body>
</html>
