<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>🎤 Voice Chat with GPT + TTS</title>
</head>
<body>
  <h2>🗣️ Voice → STT → GPT → TTS</h2>

  <label>Firebase Token:</label><br>
  <input id="token" placeholder="Bearer ..." size="80" /><br><br>

  <button onclick="startRecording()">🎙️ Start Recording</button>
  <button onclick="stopRecording()">⏹️ Stop</button>

  <h3>🧠 GPT 응답:</h3>
  <div id="response" style="white-space: pre-wrap; border: 1px solid #ccc; padding: 10px;"></div>

  <script>
    let socket;
    let mediaRecorder;
    let audioChunks = [];
    let eventStream;

    function appendText(text) {
      const div = document.getElementById("response");
      div.innerText += text;
    }

    async function startRecording() {

      // 1. WebSocket 연결
      const token = document.getElementById("token").value;
      const socket = new WebSocket("ws://localhost:8000/voice-chat?token=" + encodeURIComponent(token));


      socket.onopen = () => {
        console.log("✅ WebSocket 연결됨");
      };

      socket.onmessage = (event) => {
        if (event.data.startsWith("event: audio")) {
          // 다음 줄이 data
          const b64 = event.data.split("\n")[1].replace("data: ", "").trim();
          const audio = new Audio("data:audio/mp3;base64," + b64);
          audio.play();
        } else {
          appendText(event.data);
        }
      };

      socket.onerror = () => {
        console.error("❌ WebSocket 에러");
      };

      // 2. 마이크 녹음
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      mediaRecorder = new MediaRecorder(stream);
      audioChunks = [];

      mediaRecorder.ondataavailable = (e) => {
        if (e.data.size > 0) audioChunks.push(e.data);
      };

      mediaRecorder.onstop = async () => {
        const audioBlob = new Blob(audioChunks, { type: "audio/mp3" });
        const buffer = await audioBlob.arrayBuffer();
        socket.send(buffer);
      };

      mediaRecorder.start();
      console.log("🎙️ 녹음 시작");
    }

    function stopRecording() {
      if (mediaRecorder && mediaRecorder.state !== "inactive") {
        mediaRecorder.stop();
        console.log("⏹️ 녹음 중지");
      }
    }
  </script>
</body>
</html>
